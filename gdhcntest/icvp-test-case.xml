<?xml version="1.0" encoding="UTF-8"?>
<testcase id="icvp-test-case"
  xmlns="http://www.gitb.com/tdl/v1/"
  xmlns:gitb="http://www.gitb.com/core/v1/">

  <metadata>
    <gitb:name>ICVP: Barcode Image → IPS Bundle</gitb:name>
    <gitb:description>
      Upload a barcode image, decode to HC1 and CWT payload, install IGs on Matchbox via SMART Helper,
      transform inner content using ICVPClaimtoIPS, and validate the result against IPS Bundle profile.
    </gitb:description>
    <gitb:version>1.0</gitb:version>
  </metadata>

  <actors>
    <gitb:actor id="User" role="SUT"/>
    <gitb:actor id="HCertDecoder"/>
    <gitb:actor id="SMARTHelper"/>
    <gitb:actor id="FHIRValidator"/>
  </actors>

  <steps>

    <!-- ===================== 1) Upload barcode image and decode to qr_data ===================== -->
    <interact id="userFileUpload" desc="Upload barcode image (PNG/JPG)">
      <request desc="File to upload:" name="uploadedFile" inputType="UPLOAD" required="true"/>
    </interact>

    <!-- Build multipart part named 'image' for /decode/image -->
    <assign to="imgPart{name}">"image"</assign>
    <assign to="imgPart{contentType}">"image/png"</assign>
    <assign to="imgPart{fileName}">"barcode.png"</assign>
    <assign to="imgPart{content}">$userFileUpload{uploadedFile}</assign>
    <assign to="parts" append="true">$imgPart</assign>

    <!-- Ask for JSON so ITB parses response as JSON (not base64) -->
    <assign to="reqHeaders{Accept}">"application/json"</assign>

    <send id="decodeImage" desc="Decode QR image → qr_data" handler="HttpMessagingV2" from="User" to="HCertDecoder">
      <input name="uri">"http://hcert-validator:8080/decode/image"</input>
      <input name="method">"POST"</input>
      <input name="parts">$parts</input>
      <input name="headers">$reqHeaders</input>
    </send>

    <verify handler="NumberValidator" desc="Image decode returns HTTP 200">
      <input name="actualnumber">$decodeImage{response}{status}</input>
      <input name="expectednumber">"200"</input>
    </verify>

    <!-- Extract qr_data (HC1:...) -->
    <process handler="JsonPointerProcessor" operation="process" output="qrData">
      <input name="content">$decodeImage{response}{body}</input>
      <input name="pointer">"/qr_data"</input>
    </process>

    <!-- ===================== 2) Decode HC1 → COSE, PAYLOAD, HCERT ===================== -->
    <!-- Build {"qr_data":"<HC1...>"} safely -->
    <assign to="tpl1{qr}">$qrData</assign>
    <process handler="TemplateProcessor" operation="process" output="qrBody">
      <input name="syntax">"freemarker"</input>
      <input name="template">'{"qr_data":"${qr?json_string}"}'</input>
      <input name="parameters">$tpl1</input>
    </process>

    <assign to="jsonHeaders{Content-Type}">"application/json"</assign>
    <assign to="jsonHeaders{Accept}">"application/json"</assign>

    <send id="decodeHC1" desc="Decode HC1" handler="HttpMessagingV2" from="User" to="HCertDecoder">
      <input name="uri">"http://hcert-validator:8080/decode/hcert"</input>
      <input name="method">"POST"</input>
      <input name="headers">$jsonHeaders</input>
      <input name="body">$qrBody</input>
    </send>

    <verify handler="NumberValidator" desc="HC1 decode returns HTTP 200">
      <input name="actualnumber">$decodeHC1{response}{status}</input>
      <input name="expectednumber">"200"</input>
    </verify>

    <!-- Extract full CWT payload object and the inner content (-260/-6) -->
    <process handler="JsonPointerProcessor" operation="process" output="cwtPayload">
      <input name="content">$decodeHC1{response}{body}</input>
      <input name="pointer">"/payload"</input>
    </process>

    <process handler="JsonPointerProcessor" operation="process" output="innerContent">
      <input name="content">$cwtPayload</input>
      <input name="pointer">"/-260/-6"</input>
    </process>

    <!-- ===================== 3) Upload both IGs to Matchbox via SMART Helper ===================== -->
    <assign to="igHeaders{Content-Type}">"application/json"</assign>
    <assign to="igHeaders{Accept}">"application/json"</assign>

    <!-- IG #1 -->
    <assign to="tplIg1{ig_url}">'https://build.fhir.org/ig/costateixeira/smart-trust-phw/'</assign>
    <process handler="TemplateProcessor" operation="process" output="igBody1">
      <input name="syntax">"freemarker"</input>
      <input name="template">'{"ig_url":${ig_url?json_string}}'</input>
      <input name="parameters">$tplIg1</input>
    </process>

    <send id="uploadIG1" desc="Upload IG #1 to Matchbox"
          handler="HttpMessagingV2" from="User" to="SMARTHelper">
      <input name="uri">"http://smart-helper:8000/upload_ig/matchbox"</input>
      <input name="method">"POST"</input>
      <input name="headers">$igHeaders</input>
      <input name="body">$igBody1</input>
    </send>

    <!-- IG #2 -->
    <assign to="tplIg2{ig_url}">'https://worldhealthorganization.github.io/smart-icvp/branches/ritika'</assign>
    <process handler="TemplateProcessor" operation="process" output="igBody2">
      <input name="syntax">"freemarker"</input>
      <input name="template">'{"ig_url":${ig_url?json_string}}'</input>
      <input name="parameters">$tplIg2</input>
    </process>

    <send id="uploadIG2" desc="Upload IG #2 to Matchbox"
          handler="HttpMessagingV2" from="User" to="SMARTHelper">
      <input name="uri">"http://smart-helper:8000/upload_ig/matchbox"</input>
      <input name="method">"POST"</input>
      <input name="headers">$igHeaders</input>
      <input name="body">$igBody2</input>
    </send>

    <!-- ===================== 4) Transform inner content with ICVPClaimtoIPS ===================== -->
    <!-- Option A: Use dynamic innerContent (uncomment to use live content) -->
    <!--
    <assign to="tplIn{obj}">$innerContent</assign>
    <process handler="TemplateProcessor" operation="process" output="transformBody">
      <input name="syntax">"freemarker"</input>
      <input name="template">'${obj}'</input>
      <input name="parameters">$tplIn</input>
    </process>
    -->

    <!-- Option B: Hard-coded JSON body (kept for stability while debugging) -->
    <assign to="transformBody">
'{"dob":"1994-10-13","gn":"Parent/Antonio Rojas","n":"Cristina Rodriguez","ndt":"NI","nid":"126008-7","ntl":"CHL","s":"male","v":{"bo":"A1234","cn":"Juan Castro","dt":"2020-11-15","is":"MINSALUD","vle":"2025-11-15","vls":"2020-11-15","vp":"YellowFeverProductd2c75a15ed309658b3968519ddb31690"}}'
    </assign>

    <!-- Send transform -->
    <assign to="xformHeaders{Content-Type}">"application/fhir+json"</assign>
    <assign to="xformHeaders{Accept}">"application/json"</assign>
    <assign to="q{source}">'http://smart.who.int/icvp/StructureMap/ICVPClaimtoIPS'</assign>

    <send id="doTransform" desc="StructureMap $transform (SMART Helper)"
          handler="HttpMessagingV2" from="User" to="SMARTHelper">
      <input name="uri">"http://smart-helper:8000/transform"</input>
      <input name="method">"POST"</input>
      <input name="headers">$xformHeaders</input>
      <input name="parameters">$q</input> <!-- lets handler URL-encode -->
      <input name="body">$transformBody</input>
    </send>

    <verify handler="NumberValidator" desc="Transform HTTP 200">
      <input name="actualnumber">$doTransform{response}{status}</input>
      <input name="expectednumber">"200"</input>
    </verify>

    <!-- Extract result Bundle from SMART Helper response: { ok, result, ... } -->
    <process handler="JsonPointerProcessor" operation="process" output="bundleResult">
      <input name="content">$doTransform{response}{body}</input>
      <input name="pointer">"/result"</input>
    </process>

    <!-- ===================== 5) Validate IPS Bundle profile ===================== -->
    <assign to="tplVal{res}">$bundleResult</assign>
    <assign to="tplVal{profile}">'http://hl7.org/fhir/uv/ips/StructureDefinition/Bundle-uv-ips'</assign>
    <process handler="TemplateProcessor" operation="process" output="validateBody">
      <input name="syntax">"freemarker"</input>
      <input name="template">'{"resource": ${res}, "profile_url": ${profile}}'</input>
      <input name="parameters">$tplVal</input>
    </process>

    <send id="validateIPS" desc="Validate IPS Bundle (via SMART Helper)" handler="HttpMessagingV2" from="User" to="FHIRValidator">
      <input name="uri">"http://smart-helper:8000/validate"</input>
      <input name="method">"POST"</input>
      <input name="headers">$jsonHeaders</input>
      <input name="body">$validateBody</input>
    </send>

    <verify handler="NumberValidator" desc="Validation HTTP 200">
      <input name="actualnumber">$validateIPS{response}{status}</input>
      <input name="expectednumber">"200"</input>
    </verify>

  </steps>

  <output>
    <success>
      <default>"Barcode decoded, CWT transformed to IPS Bundle, and validation executed successfully."</default>
    </success>
  </output>
</testcase>
